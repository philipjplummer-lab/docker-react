- name: Configure AWS credentials
  uses: aws-actions/configure-aws-credentials@v4
  with:
    aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
    aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
    aws-region: us-east-1

- name: Login to ECR
  id: ecr
  uses: aws-actions/amazon-ecr-login@v2

- name: Build & push image
  run: |
    IMAGE="${{ steps.ecr.outputs.registry }}/frontend:${{ github.sha }}"
    docker build -t "$IMAGE" -f Dockerfile .
    docker push "$IMAGE"
    cat > Dockerrun.aws.json <<'JSON'
    {
      "AWSEBDockerrunVersion": "1",
      "Image": { "Name": "__IMAGE__", "Update": "true" },
      "Ports": [{ "ContainerPort": "80" }]
    }
    JSON
    sed -i "s|__IMAGE__|$IMAGE|g" Dockerrun.aws.json
    zip -q deploy.zip Dockerrun.aws.json

- name: Deploy to Elastic Beanstalk
  uses: einaregilsson/beanstalk-deploy@v21
  with:
    application_name: frontend
    environment_name: Frontend-env
    version_label: ${{ github.sha }}
    region: us-east-1
    existing_bucket_name: elasticbeanstalk-us-east-1-461773159105
    deployment_package: deploy.zip
